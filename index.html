<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PRIME PROJECTS</title>
  <!-- Include FullCalendar CSS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Arial', sans-serif;
      margin: 10px;
      background-color: #212121;
      color: #ffffff;
    }
    h1 {
      display: none;
    }
    .logo {
      text-align: center;
      margin-bottom: 10px;
    }
    .logo img {
      max-width: 260px;
      height: auto;
    }
    .centered-title {
      display: flex;
      justify-content: center;
      width: 100%;
    }
    .overview-title {
      text-align: center;
      color: #e0e0e0;
      margin: 10px 0;
      font-size: 1.5em;
      text-transform: uppercase;
      background-color: #005f96;
      padding: 5px 10px;
      display: inline-block;
    }
    .project-list {
      max-width: 100%;
    }
    .project-item {
      background-color: #2d2d2d;
      margin-bottom: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }
    .project-header {
      background-color: #4a4a4a;
      padding: 10px;
      color: #ffffff;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .project-header:hover {
      filter: brightness(85%);
    }
    .group-new-construction-metal {
      border: 2px solid #FFD700;
    }
    .group-metal-reroof {
      border: 2px solid #32CD32;
    }
    .group-shingle-metal-accents {
      border: 2px solid #1e73be;
    }
    .group-new-construction-shingle {
      border: 2px solid #808080;
    }
    .group-shingle-reroof {
      border: 2px solid #1e73be;
    }
    .project-header .project-title {
      font-weight: bold;
      color: #ffffff;
      margin-right: auto;
    }
    .project-header .status-block {
      padding: 2px 8px;
      border-radius: 3px;
      color: white;
      display: inline-block;
      width: 120px;
      text-align: center;
      border: 1px solid #000000;
      box-sizing: border-box;
    }
    .status-not-started {
      background-color: #797e92;
    }
    .status-tear-off {
      background-color: #1d6bdb;
    }
    .status-dry-in {
      background-color: #f0a345;
    }
    .status-wall-flashing {
      background-color: #ffd74b;
      color: #000000;
    }
    .status-waiting {
      background-color: #6941a6;
    }
    .status-install-panels {
      background-color: #229ecb;
      color: #000000;
    }
    .status-in-progress {
      background-color: #acde5e;
    }
    .status-complete {
      background-color: #379213;
    }
    .project-details {
      padding: 10px;
      display: none;
      background-color: #3a3a3a;
      color: #ffffff;
    }
    .project-details.active {
      display: block;
    }
    .detail-group {
      margin-bottom: 15px;
    }
    .detail-group h3, .detail-group h4 {
      margin: 0 0 5px 0;
      font-size: 1.1em;
      color: #ffffff;
      background-color: #555555;
      padding: 5px 0 5px 5px;
      border-radius: 0;
      width: 100%;
      text-align: left;
      border: 1px solid #000000;
    }
    .detail-group h3.group-new-construction-metal {
      background-color: #FFD700;
      color: #000000;
    }
    .detail-group h3.group-metal-reroof {
      background-color: #32CD32;
    }
    .detail-group h3.group-shingle-metal-accents {
      background-color: #1e73be;
    }
    .detail-group h3.group-new-construction-shingle {
      background-color: #808080;
    }
    .detail-group h3.group-shingle-reroof {
      background-color: #1e73be;
    }
    .detail-group h4 {
      font-size: 1em;
      margin-top: 10px;
    }
    .update-log {
      border: 1px solid #555;
      padding: 4px;
      background-color: #2d2d2d;
      border-radius: 5px;
      min-height: 50px;
      max-height: 150px;
      overflow-y: auto;
      margin-top: 5px;
    }
    .update-log p {
      margin: 0 0 5px 0;
      padding: 4px 0 4px 5px;
      background-color: #3a3a3a;
      border-radius: 3px;
      display: block;
      white-space: pre-wrap;
      text-align: left;
    }
    .update-log p.monday-note {
      margin: 0 0 5px 0;
      padding: 4px 0 4px 5px;
      background-color: #1e73be;
      border-radius: 3px;
      display: block;
      white-space: pre-wrap;
      text-align: left;
    }
    .update-log .timestamp {
      color: #e0e0e0;
      font-size: 0.9em;
      display: inline;
      margin-right: 5px;
    }
    .update-log .note-text {
      font-weight: bold;
      display: inline;
      margin-left: 0;
    }
    .detail-row {
      margin-bottom: 5px;
      text-align: left;
    }
    .detail-row.centered {
      text-align: center;
    }
    .detail-row span {
      font-weight: bold;
      margin-right: 5px;
    }
    .detail-row a {
      color: #3498db;
      text-decoration: none;
    }
    .detail-row a:hover {
      text-decoration: underline;
    }
    .detail-row.park-completion {
      background-color: rgba(0, 200, 117, 0.2);
      padding: 2px 5px;
      border-radius: 3px;
    }
    .notes-box {
      border: 1px solid #555;
      padding: 10px;
      background-color: #2d2d2d;
      border-radius: 5px;
      min-height: 50px;
      max-height: 150px;
      overflow-y: auto;
      color: #ffffff;
    }
    .notes-input {
      width: 100%;
      min-height: 80px;
      padding: 5px;
      margin-bottom: 5px;
      background-color: #2d2d2d;
      color: #ffffff;
      border: 1px solid #555;
      border-radius: 5px;
      resize: vertical;
    }
    .submit-note {
      padding: 5px 10px;
      background-color: #005f96;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .submit-note:hover {
      background-color: #004770;
    }
    .companycam-button {
      display: inline-block;
      margin: 0 auto;
      padding: 8px 12px;
      background-color: #005f96;
      color: white !important;
      text-decoration: none;
      border-radius: 5px;
      text-align: center;
    }
    .companycam-button:hover {
      background-color: #004770;
    }
    .companycam-button.unavailable {
      background-color: #808080;
      cursor: default;
    }
    .companycam-button.unavailable:hover {
      background-color: #666666;
    }
    .tool-links {
      text-align: right;
      margin: 15px 0;
      display: flex;
      justify-content: flex-end;
      align-items: center;
    }
    .tool-button {
      display: inline-block;
      padding: 10px 15px;
      margin: 5px;
      background-color: #005f96;
      color: white;
      text-decoration: none;
      border-radius: 5px;
      font-size: 16px;
    }
    .tool-button:hover {
      background-color: #004770;
    }
    .refresh-section {
      text-align: left;
      margin: 0;
    }
    .refresh-button {
      padding: 10px 15px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-right: 10px;
    }
    .refresh-button:hover {
      background-color: #218838;
    }
    .refresh-status {
      color: #e0e0e0;
      font-size: 0.9em;
      margin-right: 10px;
    }
    .calendar-toggle {
      background-color: #6941a6;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
      font-size: 16px;
    }
    .calendar-toggle:hover {
      background-color: #5a357e;
    }
    .calendar-container {
      display: none;
      min-height: 500px;
    }
    .calendar-container.active {
      display: block;
    }
    .button-container {
      display: flex;
      justify-content: center;
      margin: 10px 0;
    }
    .divider {
      border: 0;
      height: 1px;
      background: #555;
      margin: 20px 0;
    }
    .install-scheduled-title, .install-not-scheduled-title {
      text-align: center;
      color: #e0e0e0;
      margin: 10px 0;
    }
    #calendar {
      max-width: 100%;
      width: 100%;
      margin: 20px 0;
      background-color: #2d2d2d;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      height: 100%;
    }
    #calendar .fc {
      color: #000000;
    }
    #calendar .fc-event {
      border-color: #1e73be;
      border-width: 2px;
    }
    #calendar .fc-event-new-construction-metal {
      border-color: #FFD700;
      background-color: rgba(255, 215, 0, 0.3);
    }
    #calendar .fc-event-metal-reroof {
      border-color: #32CD32;
      background-color: rgba(50, 205, 50, 0.3);
    }
    #calendar .fc-event-shingle-metal-accents {
      border-color: #1e73be;
      background-color: rgba(30, 115, 190, 0.3);
    }
    #calendar .fc-event-new-construction-shingle {
      border-color: #808080;
      background-color: rgba(128, 128, 128, 0.3);
    }
    #calendar .fc-event-shingle-reroof {
      border-color: #1e73be;
      background-color: rgba(30, 115, 190, 0.3);
    }
    @media (min-width: 600px) {
      .project-header { padding: 12px; }
      .project-details { padding: 12px; }
    }
  </style>
</head>
<body>
  <div class="logo">
    <img src="https://primeroofingfl.com/wp-content/uploads/Prime-White-Letters.png" alt="Prime Roofing Logo">
  </div>
  <div class="centered-title">
    <h3 class="overview-title">PROJECT OVERVIEW APP</h3>
  </div>
  <hr class="divider">
  <div class="tool-links">
    <div class="refresh-section">
      <span class="refresh-status" id="refreshStatus">Last updated: Loading...</span>
      <button class="refresh-button" onclick="refreshProjects()">Refresh Now</button>
    </div>
  </div>
  <hr class="divider">
  <h3 class="install-scheduled-title">Upcoming</h3>
  <div class="project-list" id="projectList"></div>
  <hr class="divider">
  <h3 class="install-not-scheduled-title">Future Installs</h3>
  <div class="project-list unscheduled" id="unscheduledList"></div>
  <hr class="divider">
  <div class="button-container">
    <a href="https://panels.streamlit.app/" target="_blank" class="tool-button">üìê Panel Calculator Tool</a>
    <button class="calendar-toggle" onclick="toggleCalendar()">üìÖ Calendar</button>
  </div>
  <div class="calendar-container" id="calendar-container">
    <div id="calendar"></div>
  </div>

  <!-- Include FullCalendar JS -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
  <script>
    const expandedItems = new Set();

    // Status mapping for status_18 column
    const statusMap = {
      'Not Started': { display: 'Not Started', class: 'status-not-started' },
      'Old Roof Removal': { display: 'Tear-Off', class: 'status-tear-off' },
      'Ready to Dry in': { display: 'Dry-In', class: 'status-dry-in' },
      'Install Wall Flashing': { display: 'Wall Flashing', class: 'status-wall-flashing' },
      'Dry and Flashed (Waiting)': { display: 'Waiting', class: 'status-waiting' },
      'Ready to Install': { display: 'Ready for Panels', class: 'status-install-panels' },
      'Installing': { display: 'In-Progress', class: 'status-in-progress' },
      'Ready for Final': { display: 'Complete', class: 'status-complete' },
      'Register Warranty': { display: 'Complete', class: 'status-complete' }
    };

    function toggleDetails(detailsElement, itemId) {
      detailsElement.classList.toggle('active');
      if (detailsElement.classList.contains('active')) {
        expandedItems.add(itemId);
        fetchUpdates([...expandedItems]);
      } else {
        expandedItems.delete(itemId);
      }
    }

    function toggleCalendar() {
      const calendarContainer = document.getElementById('calendar-container');
      calendarContainer.classList.toggle('active');
    }

    async function fetchProjects() {
      try {
        document.getElementById('refreshStatus').textContent = 'Refreshing...';
        const response = await fetch('/projects');
        if (!response.ok) {
          throw new Error('Network response was not ok: ' + response.statusText);
        }
        const data = await response.json();
        console.log('Fetched data:', data);
        renderProjects(data);
        document.getElementById('refreshStatus').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
      } catch (error) {
        console.error('Fetch error:', error);
        document.getElementById('refreshStatus').textContent = 'Error fetching data';
      }
    }

    function renderProjects(data) {
      const projectList = document.getElementById('projectList');
      const unscheduledList = document.getElementById('unscheduledList');
      if (!projectList || !unscheduledList) {
        console.error('projectList or unscheduledList element not found!');
        return;
      }
      console.log('Starting to process items, scheduled count:', data.scheduled.length, 'unscheduled count:', data.unscheduled.length);

      projectList.innerHTML = '';
      unscheduledList.innerHTML = '';

      const calendarEl = document.getElementById('calendar');
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        height: 'auto',
        events: data.scheduled.map(item => {
          const cols = Object.fromEntries(item.columns.map(c => [c.id, c]));
          const timeline = cols['timeline'] && cols['timeline'].value && cols['timeline'].value.from ? cols['timeline'].value : null;
          if (!timeline) return null;
          const groupClass = item.group === 'New Construction - Metal Roofs' ? 'new-construction-metal' :
            item.group === 'Metal Reroofs' ? 'metal-reroof' :
            item.group === 'Shingle w/ Metal Accents' ? 'shingle-metal-accents' :
            item.group === 'New Construction Shingle' ? 'new-construction-shingle' :
            item.group === 'Shingle Reroofs' ? 'shingle-reroof' : '';
          return {
            title: item.name,
            start: timeline.from,
            end: timeline.to || timeline.from,
            className: `fc-event-${groupClass}`
          };
        }).filter(event => event !== null),
        eventClick: function(info) {
          alert('Project: ' + info.event.title + '\nSchedule: ' + formatDateRange(info.event.start, info.event.end));
        }
      });
      calendar.render();

      data.scheduled.forEach((item, index) => {
        console.log(`Attempting to process scheduled item ${index + 1}/${data.scheduled.length}:`, item);
        try {
          console.log(`Processing scheduled item ${index + 1}/${data.scheduled.length}: ${item.name || 'Unnamed'}`);
          const cols = Object.fromEntries(item.columns.map(c => [c.id, c]));
          console.log('Columns for scheduled item:', cols);

          const address = cols['site_address_mkn23t2r'] ? cols['site_address_mkn23t2r'].text || cols['site_address_mkn23t2r'].value || 'N/A' : 'N/A';
          const projectNotes = cols['long_text_mkp2xwpw'] ? cols['long_text_mkp2xwpw'].text || 'N/A' : 'N/A';
          const companyCamUrl = cols['link3'] && cols['link3'].value && cols['link3'].value.url ? cols['link3'].value.url : '';
          const companyCamClass = companyCamUrl ? 'companycam-button' : 'companycam-button unavailable';
          const companyCam = companyCamUrl
            ? `<a href="${companyCamUrl}" target="_blank" class="${companyCamClass}">Photos</a>`
            : `<span class="${companyCamClass}">No Photos Yet</span>`;
          const jobSize = cols['numbers_14'] ? (cols['numbers_14'].text || cols['numbers_14'].value) + 'sq' || 'N/A' : 'N/A';
          const parkCompletionRaw = cols['numeric_mkp4xeef'] ? (cols['numeric_mkp4xeef'].text || (cols['numeric_mkp4xeef'].value !== null && cols['numeric_mkp4xeef'].value !== undefined ? cols['numeric_mkp4xeef'].value.toString() : 'N/A')) : 'N/A';
          console.log(`Par Completion for ${item.name}: raw=${JSON.stringify(cols['numeric_mkp4xeef'])}, text=${cols['numeric_mkp4xeef']?.text}, value=${cols['numeric_mkp4xeef']?.value}`);
          const parkCompletion = parkCompletionRaw !== 'N/A' ? `${parkCompletionRaw} days` : 'N/A';
          const metalColor = cols['metal_color'] ? cols['metal_color'].text || 'N/A' : 'N/A';
          const material = cols['dropdown7'] ? cols['dropdown7'].text || 'N/A' : 'N/A';
          const profile = cols['metal_profile__1'] ? cols['metal_profile__1'].text || 'N/A' : 'N/A';
          const stiffeningType = cols['dropdown1'] ? cols['dropdown1'].text || 'N/A' : 'N/A';
          const timeline = cols['timeline'] && cols['timeline'].value && cols['timeline'].value.from ? formatDateRange(cols['timeline'].value.from, cols['timeline'].value.to) : 'N/A';
          const statusRaw = cols['status_18'] ? cols['status_18'].text.trim() : 'N/A';
          console.log(`Status for ${item.name}: status_18=${JSON.stringify(cols['status_18'])}, raw=${statusRaw}`);
          const statusInfo = statusMap[statusRaw] || { display: statusRaw, class: 'status-not-started' };
          const statusDisplay = statusInfo.display;
          const statusClass = statusInfo.class;
          const group = item.group || 'No Group';
          const groupClass = group === 'New Construction - Metal Roofs' ? 'group-new-construction-metal' :
            group === 'Metal Reroofs' ? 'group-metal-reroof' :
            group === 'Shingle w/ Metal Accents' ? 'group-shingle-metal-accents' :
            group === 'New Construction Shingle' ? 'group-new-construction-shingle' :
            group === 'Shingle Reroofs' ? 'group-shingle-reroof' : '';

          const projectItem = document.createElement('div');
          projectItem.className = 'project-item';
          projectItem.innerHTML = `
            <div class="project-header ${groupClass}">
              <span class="project-title">${item.name || 'Unnamed'}</span>
              <span class="status-block ${statusClass}">${statusDisplay}</span>
            </div>
            <div class="project-details">
              <div class="detail-group">
                <h3 class="${groupClass}">${group}</h3>
                <div class="detail-row"><span>Address:</span><a href="https://maps.google.com/?q=${encodeURIComponent(address)}" target="_blank">${address}</a></div>
                <div class="detail-row"><span>Job Size:</span>${jobSize}</div>
                <div class="detail-row"><span>Schedule:</span>${timeline}</div>
                <div class="detail-row park-completion"><span>Par Completion:</span>${parkCompletion}</div>
              </div>
              <div class="detail-group">
                <div class="detail-row centered">${companyCam}</div>
                <h3>Project Notes</h3>
                <div class="notes-box">${projectNotes}</div>
              </div>
              <div class="detail-group">
                <h3>Metal Specs</h3>
                <div class="detail-row"><span>Metal Color:</span>${metalColor}</div>
                <div class="detail-row"><span>Material:</span>${material}</div>
                <div class="detail-row"><span>Profile:</span>${profile}</div>
                <div class="detail-row"><span>Stiffening Type:</span>${stiffeningType}</div>
              </div>
              <div class="detail-group">
                <h3>Crew Notes</h3>
                <textarea class="notes-input" id="notes-${item.id}" placeholder="Enter in field notes or updates here. Notes added here will also be sent to the office"></textarea>
                <button class="submit-note" onclick="submitNote('${item.id}')">Submit Note</button>
                <h4>Comm Log</h4>
                <div class="update-log" id="update-log-${item.id}"></div>
              </div>
            </div>
          `;
          projectItem.querySelector('.project-header').addEventListener('click', () => toggleDetails(projectItem.querySelector('.project-details'), item.id));
          projectList.appendChild(projectItem);

          console.log(`Rendering scheduled ${item.name || 'Unnamed'}: Project Notes=${projectNotes}, Timeline=${timeline}`);
        } catch (error) {
          console.error(`Error rendering scheduled item ${item.name || 'Unnamed'}:`, error);
        }
      });

      data.unscheduled.forEach((item, index) => {
        console.log(`Attempting to process unscheduled item ${index + 1}/${data.unscheduled.length}:`, item);
        try {
          console.log(`Processing unscheduled item ${index + 1}/${data.unscheduled.length}: ${item.name || 'Unnamed'}`);
          const cols = Object.fromEntries(item.columns.map(c => [c.id, c]));
          console.log('Columns for unscheduled item:', cols);

          const address = cols['site_address_mkn23t2r'] ? cols['site_address_mkn23t2r'].text || cols['site_address_mkn23t2r'].value || 'N/A' : 'N/A';
          const projectNotes = cols['long_text_mkp2xwpw'] ? cols['long_text_mkp2xwpw'].text || 'N/A' : 'N/A';
          const companyCamUrl = cols['link3'] && cols['link3'].value && cols['link3'].value.url ? cols['link3'].value.url : '';
          const companyCamClass = companyCamUrl ? 'companycam-button' : 'companycam-button unavailable';
          const companyCam = companyCamUrl
            ? `<a href="${companyCamUrl}" target="_blank" class="${companyCamClass}">Photos</a>`
            : `<span class="${companyCamClass}">No Photos Yet</span>`;
          const jobSize = cols['numbers_14'] ? (cols['numbers_14'].text || cols['numbers_14'].value) + 'sq' || 'N/A' : 'N/A';
          const parkCompletionRaw = cols['numeric_mkp4xeef'] ? (cols['numeric_mkp4xeef'].text || (cols['numeric_mkp4xeef'].value !== null && cols['numeric_mkp4xeef'].value !== undefined ? cols['numeric_mkp4xeef'].value.toString() : 'N/A')) : 'N/A';
          console.log(`Par Completion for ${item.name}: raw=${JSON.stringify(cols['numeric_mkp4xeef'])}, text=${cols['numeric_mkp4xeef']?.text}, value=${cols['numeric_mkp4xeef']?.value}`);
          const parkCompletion = parkCompletionRaw !== 'N/A' ? `${parkCompletionRaw} days` : 'N/A';
          const metalColor = cols['metal_color'] ? cols['metal_color'].text || 'N/A' : 'N/A';
          const material = cols['dropdown7'] ? cols['dropdown7'].text || 'N/A' : 'N/A';
          const profile = cols['metal_profile__1'] ? cols['metal_profile__1'].text || 'N/A' : 'N/A';
          const stiffeningType = cols['dropdown1'] ? cols['dropdown1'].text || 'N/A' : 'N/A';
          const timeline = cols['timeline'] && cols['timeline'].value && cols['timeline'].value.from ? formatDateRange(cols['timeline'].value.from, cols['timeline'].value.to) : 'N/A';
          const statusRaw = cols['status_18'] ? cols['status_18'].text.trim() : 'N/A';
          console.log(`Status for ${item.name}: status_18=${JSON.stringify(cols['status_18'])}, raw=${statusRaw}`);
          const statusInfo = statusMap[statusRaw] || { display: statusRaw, class: 'status-not-started' };
          const statusDisplay = statusInfo.display;
          const statusClass = statusInfo.class;
          const group = item.group || 'No Group';
          const groupClass = group === 'New Construction - Metal Roofs' ? 'group-new-construction-metal' :
            group === 'Metal Reroofs' ? 'group-metal-reroof' :
            group === 'Shingle w/ Metal Accents' ? 'group-shingle-metal-accents' :
            group === 'New Construction Shingle' ? 'group-new-construction-shingle' :
            group === 'Shingle Reroofs' ? 'group-shingle-reroof' : '';

          const projectItem = document.createElement('div');
          projectItem.className = 'project-item';
          projectItem.innerHTML = `
            <div class="project-header ${groupClass}">
              <span class="project-title">${item.name || 'Unnamed'}</span>
              <span class="status-block ${statusClass}">${statusDisplay}</span>
            </div>
            <div class="project-details">
              <div class="detail-group">
                <h3 class="${groupClass}">${group}</h3>
                <div class="detail-row"><span>Address:</span><a href="https://maps.google.com/?q=${encodeURIComponent(address)}" target="_blank">${address}</a></div>
                <div class="detail-row"><span>Job Size:</span>${jobSize}</div>
                <div class="detail-row"><span>Schedule:</span>${timeline}</div>
                <div class="detail-row park-completion"><span>Par Completion:</span>${parkCompletion}</div>
              </div>
              <div class="detail-group">
                <div class="detail-row centered">${companyCam}</div>
                <h3>Project Notes</h3>
                <div class="notes-box">${projectNotes}</div>
              </div>
              <div class="detail-group">
                <h3>Metal Specs</h3>
                <div class="detail-row"><span>Metal Color:</span>${metalColor}</div>
                <div class="detail-row"><span>Material:</span>${material}</div>
                <div class="detail-row"><span>Profile:</span>${profile}</div>
                <div class="detail-row"><span>Stiffening Type:</span>${stiffeningType}</div>
              </div>
              <div class="detail-group">
                <h3>Crew Notes</h3>
                <textarea class="notes-input" id="notes-${item.id}" placeholder="Enter in field notes or updates here. Notes added here will also be sent to the office"></textarea>
                <button class="submit-note" onclick="submitNote('${item.id}')">Submit Note</button>
                <h4>Comm Log</h4>
                <div class="update-log" id="update-log-${item.id}"></div>
              </div>
            </div>
          `;
          projectItem.querySelector('.project-header').addEventListener('click', () => toggleDetails(projectItem.querySelector('.project-details'), item.id));
          unscheduledList.appendChild(projectItem);

          console.log(`Rendering unscheduled ${item.name || 'Unnamed'}: Project Notes=${projectNotes}, Timeline=${timeline}`);
        } catch (error) {
          console.error(`Error rendering unscheduled item ${item.name || 'Unnamed'}:`, error);
        }
      });
      console.log('Finished processing items');
    }

    function refreshProjects() {
      fetchProjects();
    }

    try {
      console.log('Fetching projects...');
      fetchProjects();
      setInterval(() => {
        console.log('Periodic refresh triggered');
        fetchProjects();
      }, 900000);
    } catch (error) {
      console.error('Top-level script error:', error);
    }

    async function fetchUpdates(itemIds) {
      try {
        const updatePromises = itemIds.map(itemId => 
          fetch(`/updates/${itemId}`).then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error for item ${itemId}! status: ${response.status}`);
            }
            return response.json().then(updates => ({ itemId, updates }));
          })
        );
        const results = await Promise.all(updatePromises);
        console.log(`Fetched updates for items ${itemIds.join(', ')}:`, results);

        results.forEach(({ itemId, updates }) => {
          const updateLog = document.getElementById(`update-log-${itemId}`);
          if (!updateLog) return;

          // Log all updates before filtering
          console.log(`Raw updates for item ${itemId}:`, updates);

          const stripHtml = (html) => {
            const div = document.createElement('div');
            div.innerHTML = html;
            return div.textContent || div.innerText || '';
          };

          const updateEntries = (updates || [])
            .filter(update => {
              const matches = update.body.toLowerCase().includes('@metal crew one') || 
                              update.body.toLowerCase().includes('[field update]') || 
                              update.body.toLowerCase().includes('[field note]');
              console.log(`Update for item ${itemId}: body="${update.body}", matches=${matches}`);
              return matches;
            })
            .map(update => {
              let displayBody = stripHtml(update.body)
                .replace(/@Metal Crew One/gi, '')
                .replace(/\[FIELD UPDATE\]/gi, '')
                .replace(/\[FIELD NOTE\]/gi, '')
                .replace(/@Zach/gi, '')
                .trim();
              displayBody = displayBody.replace(/\s+/g, ' ').trim();
              const isMondayNote = update.body.toLowerCase().includes('@metal crew one') && 
                                  !update.body.toLowerCase().includes('[field update]') && 
                                  !update.body.toLowerCase().includes('[field note]');
              const creatorName = (update.body.toLowerCase().includes('[field update]') || 
                                  update.body.toLowerCase().includes('[field note]')) ? '' : 
                                  update.creator ? update.creator.name : '';
              return `
                <p class="${isMondayNote ? 'monday-note' : ''}">
                  <span class="timestamp">[${formatTimestamp(new Date(update.created_at))}]${creatorName ? ` ${creatorName}` : ''}</span>
                  <span class="note-text">${displayBody || 'No content'}</span>
                </p>
              `;
            }).join('');
          updateLog.innerHTML = updateEntries || '<p>No updates available.</p>';
        });
      } catch (error) {
        console.error(`Error fetching updates for items ${itemIds.join(', ')}:`, error);
        itemIds.forEach(itemId => {
          const updateLog = document.getElementById(`update-log-${itemId}`);
          if (updateLog) updateLog.innerHTML = '<p>Error loading updates.</p>';
        });
      }
    }

    async function submitNote(itemId) {
      const noteText = document.getElementById(`notes-${itemId}`).value;
      if (!noteText.trim()) {
        alert('Please enter a note before submitting.');
        return;
      }

      try {
        const response = await fetch('/submit-note', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ itemId, noteText })
        });
        const result = await response.json();
        if (result.success) {
          alert('Note submitted successfully!');
          document.getElementById(`notes-${itemId}`).value = '';
          setTimeout(() => fetchUpdates([...expandedItems]), 2000);
        } else {
          console.error('Error submitting note:', result);
          alert('Failed to submit note: ' + (result.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error submitting note:', error);
        alert('Error submitting note. Check console for details.');
      }
    }

    function formatTimestamp(date) {
      const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      const day = date.getUTCDate();
      const getDaySuffix = (day) => {
        if (day > 3 && day < 21) return 'th';
        switch (day % 10) {
          case 1: return 'st';
          case 2: return 'nd';
          case 3: return 'rd';
          default: return 'th';
        }
      };
      const monthDay = `${months[date.getUTCMonth()]} ${day}${getDaySuffix(day)}`;
      const time = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
      return `${monthDay} ${time}`;
    }

    function formatDateRange(fromDate, toDate) {
      if (!fromDate) return 'N/A';
      const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      const getDaySuffix = (day) => {
        if (day > 3 && day < 21) return 'th';
        switch (day % 10) {
          case 1: return 'st';
          case 2: return 'nd';
          case 3: return 'rd';
          default: return 'th';
        }
      };
      const from = new Date(fromDate);
      const formattedFrom = `${months[from.getUTCMonth()]} ${from.getUTCDate()}${getDaySuffix(from.getUTCDate())}`;
      const formattedTo = toDate ? ` - ${months[new Date(toDate).getUTCMonth()]} ${new Date(toDate).getUTCDate()}${getDaySuffix(new Date(toDate).getUTCDate())}` : '';
      return `${formattedFrom}${formattedTo}`;
    }
  </script>
</body>
</html>